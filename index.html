<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Secure Inbox Quiz — GBL (Stable, Attractive, Mobile-First)</title>
  <style>
    :root{
      --bg0:#050a16;
      --bg1:#071025;
      --ink:#eaf0ff;
      --muted:#b9c6ff;

      --panel:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.14);
      --shadow:0 12px 34px rgba(0,0,0,.38);

      --good:#39d98a;
      --bad:#ff5c7a;
      --warn:#ffd84d;

      --a:#7c5cff;
      --b:#33d6ff;
      --c:#ff7ad9;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 520px at 75% 8%, rgba(51,214,255,.16), transparent 60%),
        radial-gradient(900px 520px at 18% 18%, rgba(124,92,255,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .wrap{height:100dvh; display:flex; flex-direction:column;}
    header{
      padding:12px 14px 10px;
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:2px; min-width:260px;}
    .brand .t{font-weight:950;}
    .brand .s{font-size:12px; color:var(--muted)}
    .hud{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:8px 10px;
      box-shadow:var(--shadow);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      backdrop-filter: blur(8px);
      user-select:none;
    }
    .pill b{font-size:13px}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:var(--ink);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:850;
      box-shadow:var(--shadow);
      user-select:none;
      transition: transform .05s ease;
    }
    .btn:active{transform:translateY(1px)}

    main{
      flex:1;
      padding:0 12px 12px;
      display:flex;
      gap:10px;
      align-items:stretch;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px;
      backdrop-filter: blur(10px);
      position:relative;
      overflow:hidden;
    }

    .left{flex:1.2; min-width:320px;}
    .right{flex:1.8; min-width:360px; display:flex; flex-direction:column; gap:10px;}

    .qTitle{display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:8px;}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(100,181,255,.16);
      border:1px solid rgba(100,181,255,.35);
      white-space:nowrap;
      user-select:none;
    }
    .qText{font-size:16px; line-height:1.28; font-weight:950; margin-top:4px;}
    .choices{margin-top:10px; display:grid; gap:8px;}
    .choice{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
      font-size:13px;
      user-select:none;
    }
    .tag{
      width:30px; height:30px; border-radius:10px;
      display:grid; place-items:center;
      font-weight:950; color:#0b1220;
      flex:0 0 auto;
      margin-top:1px;
    }
    .tag.A{background:var(--a)}
    .tag.B{background:var(--b)}
    .tag.C{background:var(--c)}
    .muted{color:var(--muted)}

    .readWrap{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.10);
      display:none;
    }
    .readLabel{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:var(--muted); font-weight:800;
      margin-bottom:8px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(51,214,255,.85), rgba(124,92,255,.85));
    }

    .statusLine{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.10);
      font-size:12px;
      color:var(--muted);
      display:none;
    }

    /* Inbox area */
    .inboxTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .inboxTitle{
      display:flex; flex-direction:column; gap:2px;
    }
    .inboxTitle .h{font-weight:950}
    .inboxTitle .p{font-size:12px; color:var(--muted)}
    .mailBox{
      flex:1;
      min-height:300px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(0,0,0,.10), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }

    /* Animated grid background inside mailbox */
    .grid{
      position:absolute; inset:0;
      background:
        linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 28px 28px;
      opacity:.18;
      transform: translateY(0);
      animation: drift 6s linear infinite;
    }
    @keyframes drift{
      from{ transform: translateY(0); }
      to{ transform: translateY(28px); }
    }

    /* Email card */
    .mail{
      position:absolute;
      left:50%;
      top:55%;
      transform: translate(-50%,-50%);
      width:min(520px, 92%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.11), rgba(0,0,0,.12));
      box-shadow:0 18px 50px rgba(0,0,0,.55);
      padding:12px;
      overflow:hidden;
    }
    .mail::before{
      content:"";
      position:absolute; inset:-40px -60px auto auto;
      width:160px; height:160px;
      background: radial-gradient(circle, rgba(51,214,255,.35), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .mailHead{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.10);
      color:var(--muted);
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background:rgba(255,255,255,.40);
      box-shadow:0 0 14px rgba(255,255,255,.15);
    }
    .dot.good{background:rgba(57,217,138,.9); box-shadow:0 0 14px rgba(57,217,138,.35);}
    .dot.bad{background:rgba(255,92,122,.9); box-shadow:0 0 14px rgba(255,92,122,.35);}
    .dot.warn{background:rgba(255,216,77,.95); box-shadow:0 0 14px rgba(255,216,77,.35);}

    .mailFrom{font-weight:950; font-size:14px}
    .mailSub{font-weight:850; font-size:13px; color:var(--muted)}
    .mailBody{
      margin-top:10px;
      font-size:13px;
      color:rgba(234,240,255,.92);
      line-height:1.35;
      background:rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
    }

    /* Action buttons */
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .act{
      border-radius:16px;
      padding:14px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      box-shadow:var(--shadow);
      user-select:none;
      display:flex; flex-direction:column; gap:4px;
      align-items:center;
      font-weight:950;
      text-align:center;
      min-height:60px;
      cursor:pointer;
      transition: transform .06s ease, filter .12s ease;
    }
    .act:active{transform:translateY(1px)}
    .act small{font-weight:750; color:var(--muted); line-height:1.2;}
    .act.A{outline:1px solid rgba(124,92,255,.35)}
    .act.B{outline:1px solid rgba(51,214,255,.35)}
    .act.C{outline:1px solid rgba(255,122,217,.35)}
    .act.disabled{
      pointer-events:none;
      opacity:.45;
      filter: grayscale(0.35);
    }

    /* Feedback popup */
    .pop{
      position:absolute;
      left:50%;
      top:22%;
      transform:translate(-50%,-50%);
      padding:12px 14px;
      border-radius:18px;
      font-weight:950;
      display:none;
      z-index:10;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
      text-align:center;
      min-width:min(560px, 92%);
      user-select:none;
    }
    .pop.good{background:rgba(57,217,138,.20)}
    .pop.bad{background:rgba(255,92,122,.18)}
    .pop .why{display:block; margin-top:6px; font-size:12px; color:var(--muted); font-weight:800}

    /* Overlay modal */
    .overlay{
      position:fixed; inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      align-items:center; justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(900px, 96vw);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      padding:14px;
    }
    .modal h2{margin:6px 0 8px}
    .modal p, .modal li{color:var(--muted)}
    .modal .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px;}

    @media (max-width: 900px){
      main{flex-direction:column}
      .left,.right{min-width:unset}
      .mailBox{min-height:320px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="t">Secure Inbox Quiz — GBL</div>
      <div class="s">Read → Decide → Tap A/B/C (explicit) → Feedback. Stable and mobile-friendly.</div>
    </div>
    <div class="hud">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">Accuracy: <b id="acc">0%</b></div>
      <div class="pill">Q: <b id="qnum">0</b>/<span id="qtotal">0</span></div>
      <button class="btn" id="howBtn">How to Play</button>
      <button class="btn" id="restartBtn">Restart</button>
    </div>
  </header>

  <main>
    <section class="card left" aria-live="polite">
      <div class="qTitle">
        <div class="badge" id="topicBadge">Ready</div>
        <div class="muted" style="font-size:12px">Choose A/B/C using buttons or keys (1/2/3 or A/B/C).</div>
      </div>

      <div class="qText" id="qText">Press Start to begin.</div>
      <div class="choices" id="choices"></div>

      <div class="readWrap" id="readWrap">
        <div class="readLabel">
          <span>Reading time…</span>
          <span id="readSecs">0.0s</span>
        </div>
        <div class="bar"><div id="readBar"></div></div>
      </div>

      <div class="statusLine" id="statusLine"></div>
    </section>

    <section class="card right">
      <div class="inboxTop">
        <div class="inboxTitle">
          <div class="h">Inbox Simulation</div>
          <div class="p">The “email” is just a themed display. Your answer is A/B/C.</div>
        </div>
        <button class="btn" id="startBtn">Start</button>
      </div>

      <div class="mailBox" id="mailBox">
        <div class="grid"></div>

        <div class="pop" id="popup"></div>

        <div class="mail" id="mailCard" style="display:none;">
          <div class="mailHead">
            <div style="display:flex; flex-direction:column; gap:2px;">
              <div class="mailFrom" id="mailFrom">system@uou.in</div>
              <div class="mailSub" id="mailSub">Security Notice</div>
            </div>
            <div class="chip" id="riskChip"><span class="dot warn"></span><span>Awaiting decision</span></div>
          </div>
          <div class="mailBody" id="mailBody">
            Read the question and choose the correct option A/B/C below.
          </div>
        </div>
      </div>

      <div class="actions">
        <div class="act A" id="actA" role="button" tabindex="0">Choose A <small>Key: 1 / A</small></div>
        <div class="act B" id="actB" role="button" tabindex="0">Choose B <small>Key: 2 / B</small></div>
        <div class="act C" id="actC" role="button" tabindex="0">Choose C <small>Key: 3 / C</small></div>
      </div>

      <div class="muted" style="font-size:12px; padding:0 2px;">
        Tip: During reading time, buttons are disabled to avoid distraction.
      </div>
    </section>
  </main>
</div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h2 id="modalTitle">How to Play</h2>
    <div id="modalBody">
      <ul>
        <li>The game pauses for a few seconds so you can read the MCQ properly.</li>
        <li>After reading time ends, select <b>A</b>, <b>B</b>, or <b>C</b>.</li>
        <li>Correct = <b>+10</b>, Wrong = <b>0</b>. One attempt per question.</li>
        <li>Keyboard: <b>1/2/3</b> or <b>A/B/C</b>. Mobile: tap buttons.</li>
        <li>At the end you can download a CSV log for analysis.</li>
      </ul>
    </div>
    <div class="row">
      <button class="btn" id="closeModal">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Participant ID (optional): add ?pid=UOU123
   ========================================================= */
const params = new URLSearchParams(location.search);
const PID = params.get("pid") || "UOU-ANON";

/* =========================================================
   QUESTION BANK (replace with your chapter-based MCQs)
   Store correct answer as correctText (not fixed A/B/C).
   ========================================================= */
const QUESTION_BANK = [
  { id:"Q1", topic:"Smartphone Security",
    q:"Which practice best reduces risk from malicious apps?",
    options:["Install only from official stores","Disable screen lock","Keep Bluetooth always ON"],
    correctText:"Install only from official stores",
    why:"Official stores reduce exposure to unknown or repackaged apps."
  },
  { id:"Q2", topic:"Android Security",
    q:"Device encryption mainly protects data:",
    options:["When device is lost or powered off","Only when Wi-Fi is ON","Only inside browser"],
    correctText:"When device is lost or powered off",
    why:"Encryption protects stored data if the device is stolen or offline."
  },
  { id:"Q3", topic:"iOS Security",
    q:"A strong iPhone passcode improves:",
    options:["Data protection for stored content","Camera quality","Battery capacity"],
    correctText:"Data protection for stored content",
    why:"Passcode strengthens iOS data protection mechanisms."
  },
  { id:"Q4", topic:"Smartphone Security",
    q:"Public Wi-Fi is risky mainly due to:",
    options:["Interception and rogue access points","Lower brightness","Extra storage usage"],
    correctText:"Interception and rogue access points",
    why:"Public networks can be monitored or spoofed."
  },
  { id:"Q5", topic:"Android Security",
    q:"Unnecessary app permissions can lead to:",
    options:["Data leakage and privacy loss","Faster charging","Better speaker sound"],
    correctText:"Data leakage and privacy loss",
    why:"Excess permissions may expose contacts, location, files, or messages."
  },
  { id:"Q6", topic:"iOS Security",
    q:"A key benefit of Find My iPhone is:",
    options:["Locate and remotely erase a lost phone","Increase download speed","Automatically jailbreak phone"],
    correctText:"Locate and remotely erase a lost phone",
    why:"It supports location tracking and remote wipe."
  },
];

/* =========================================================
   Tuning
   ========================================================= */
const READ_PAUSE_MS = 4500;
const ANSWER_TIMEOUT_MS = 16000;   // after read ends
const FEEDBACK_MS = 900;
const QUESTIONS_PER_RUN = Math.min(QUESTION_BANK.length, 10);

/* =========================================================
   Helpers
   ========================================================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* =========================================================
   UI refs
   ========================================================= */
const scoreEl = document.getElementById("score");
const accEl   = document.getElementById("acc");
const qnumEl  = document.getElementById("qnum");
const qtotalEl= document.getElementById("qtotal");
const topicBadge = document.getElementById("topicBadge");
const qTextEl = document.getElementById("qText");
const choicesEl = document.getElementById("choices");
const readWrap = document.getElementById("readWrap");
const readBar  = document.getElementById("readBar");
const readSecs = document.getElementById("readSecs");
const statusLine = document.getElementById("statusLine");

const popupEl = document.getElementById("popup");
const mailCard = document.getElementById("mailCard");
const mailFrom = document.getElementById("mailFrom");
const mailSub  = document.getElementById("mailSub");
const mailBody = document.getElementById("mailBody");
const riskChip = document.getElementById("riskChip");

const actA = document.getElementById("actA");
const actB = document.getElementById("actB");
const actC = document.getElementById("actC");

const overlay = document.getElementById("overlay");
document.getElementById("howBtn").onclick = ()=> overlay.style.display="flex";
document.getElementById("closeModal").onclick = ()=> overlay.style.display="none";

function setStatus(text, show=true){
  statusLine.textContent = text;
  statusLine.style.display = show ? "block" : "none";
}

function setActionsEnabled(on){
  [actA,actB,actC].forEach(el=>{
    el.classList.toggle("disabled", !on);
  });
}

function showPopup(ok, correctKey, why){
  popupEl.className = "pop " + (ok ? "good" : "bad");
  popupEl.style.display = "block";
  popupEl.innerHTML = (ok ? "✅ Correct! (+10)" : "❌ Wrong!") +
    `<span class="why">Correct: ${correctKey}. ${escapeHtml(why)}</span>`;
  setTimeout(()=> popupEl.style.display="none", FEEDBACK_MS);
}

function setChip(kind, text){
  const dotClass = kind==="good" ? "dot good" : kind==="bad" ? "dot bad" : "dot warn";
  riskChip.innerHTML = `<span class="${dotClass}"></span><span>${escapeHtml(text)}</span>`;
}

/* =========================================================
   Balanced option order (fixes “A is usually correct” bias)
   ========================================================= */
function prepareQuestionsBalanced(){
  const selected = shuffle(QUESTION_BANK).slice(0, QUESTIONS_PER_RUN);
  const n = selected.length;

  const base = Math.floor(n/3);
  const targets = {A:base, B:base, C:base};
  let rem = n - 3*base;
  const order = shuffle(["A","B","C"]);
  for(let i=0;i<rem;i++) targets[order[i]]++;

  const used = {A:0,B:0,C:0};

  return selected.map(q0=>{
    const opts = q0.options.slice();
    let picked = null;

    for(let tries=0; tries<80; tries++){
      const sh = shuffle(opts);
      const map = {A:sh[0], B:sh[1], C:sh[2]};
      const correct = (map.A===q0.correctText) ? "A" : (map.B===q0.correctText) ? "B" : "C";

      if(used[correct] < targets[correct]){
        picked = {map, correct};
        break;
      }
      if(!picked) picked = {map, correct};
    }

    used[picked.correct]++;

    return {
      id:q0.id, topic:q0.topic, q:q0.q,
      A:picked.map.A, B:picked.map.B, C:picked.map.C,
      correct:picked.correct,
      correctText:q0.correctText,
      why:q0.why
    };
  });
}

/* =========================================================
   State
   ========================================================= */
const state = {
  running:false,
  phase:"menu", // menu | read | answer | feedback | end
  score:0, correct:0, attempted:0,
  questions:[], qIndex:0, current:null,

  readStart:0, readUntil:0,
  answerStart:0, answerUntil:0,
  decisionStart:0,

  log:[]
};

function updateHUD(){
  scoreEl.textContent = String(state.score);
  const acc = state.attempted ? Math.round((state.correct/state.attempted)*100) : 0;
  accEl.textContent = acc + "%";
  qnumEl.textContent = String(state.attempted);
  qtotalEl.textContent = String(state.questions.length);
}

/* =========================================================
   Rendering
   ========================================================= */
function renderQuestion(q){
  state.current = q;
  topicBadge.textContent = q.topic;
  qTextEl.textContent = q.q;

  choicesEl.innerHTML = `
    <div class="choice"><div class="tag A">A</div><div><b>${escapeHtml(q.A)}</b></div></div>
    <div class="choice"><div class="tag B">B</div><div><b>${escapeHtml(q.B)}</b></div></div>
    <div class="choice"><div class="tag C">C</div><div><b>${escapeHtml(q.C)}</b></div></div>
  `;

  // Themed inbox card (purely visual)
  mailCard.style.display = "block";
  mailFrom.textContent = "alerts@mobile-security.uou";
  mailSub.textContent = `Action required: ${q.topic}`;
  mailBody.textContent = q.q;
  setChip("warn","Awaiting your decision");
}

/* =========================================================
   Flow
   ========================================================= */
function startQuestion(){
  if(state.qIndex >= state.questions.length){
    endGame();
    return;
  }

  popupEl.style.display="none";
  setStatus("", false);
  setActionsEnabled(false);

  const q = state.questions[state.qIndex++];
  renderQuestion(q);

  // READ phase
  state.phase = "read";
  state.readStart = performance.now();
  state.readUntil = state.readStart + READ_PAUSE_MS;

  readWrap.style.display = "block";
  readBar.style.width = "0%";
  readSecs.textContent = (READ_PAUSE_MS/1000).toFixed(1) + "s";
  setStatus("Reading time… buttons disabled.", true);

  setTimeout(()=>{
    if(!state.running) return;
    if(state.phase !== "read") return;

    // ANSWER phase
    readWrap.style.display = "none";
    state.phase = "answer";
    state.answerStart = performance.now();
    state.answerUntil = state.answerStart + ANSWER_TIMEOUT_MS;
    state.decisionStart = performance.now();

    setActionsEnabled(true);
    setStatus("Select A, B, or C now.", true);
    setChip("warn","Decision window open");

    // auto-timeout
    setTimeout(()=>{
      if(state.phase === "answer"){
        recordNoAnswer("Time expired (no selection).");
      }
    }, ANSWER_TIMEOUT_MS);

  }, READ_PAUSE_MS);
}

function nextQuestion(){
  popupEl.style.display="none";
  setStatus("", false);
  setTimeout(()=> startQuestion(), 650);
}

/* =========================================================
   Answer handling
   ========================================================= */
function recordAnswer(letter){
  if(state.phase !== "answer") return;

  setActionsEnabled(false);

  const q = state.current;
  const ok = (letter === q.correct);

  state.attempted++;
  if(ok){
    state.correct++;
    state.score += 10;
    setChip("good","Approved safe action");
  }else{
    setChip("bad","Unsafe action detected");
  }

  const rt = Math.max(0, Math.round(performance.now() - state.decisionStart));

  state.log.push({
    ts: new Date().toISOString(),
    pid: PID,
    qid: q.id,
    topic: q.topic,
    option_order: `A:${q.A} | B:${q.B} | C:${q.C}`,
    selected: letter,
    correct: q.correct,
    is_correct: ok ? 1 : 0,
    response_ms: rt,
    score_after: state.score
  });

  updateHUD();
  showPopup(ok, q.correct, q.why);

  state.phase = "feedback";
  setTimeout(()=> nextQuestion(), FEEDBACK_MS);
}

function recordNoAnswer(reason){
  if(state.phase !== "answer") return;

  setActionsEnabled(false);

  state.attempted++;
  const q = state.current;
  const rt = Math.max(0, Math.round(performance.now() - state.decisionStart));

  state.log.push({
    ts: new Date().toISOString(),
    pid: PID,
    qid: q.id,
    topic: q.topic,
    option_order: `A:${q.A} | B:${q.B} | C:${q.C}`,
    selected: "NA",
    correct: q.correct,
    is_correct: 0,
    response_ms: rt,
    score_after: state.score
  });

  updateHUD();
  setChip("bad","No decision recorded");
  showPopup(false, q.correct, reason || "No answer recorded.");
  state.phase = "feedback";
  setTimeout(()=> nextQuestion(), FEEDBACK_MS);
}

/* Buttons + keyboard */
actA.onclick = ()=> recordAnswer("A");
actB.onclick = ()=> recordAnswer("B");
actC.onclick = ()=> recordAnswer("C");

window.addEventListener("keydown",(e)=>{
  if(state.phase !== "answer") return;
  const k = e.code;
  if(["Digit1","Digit2","Digit3","KeyA","KeyB","KeyC"].includes(k)) e.preventDefault();
  if(k==="Digit1" || k==="KeyA") recordAnswer("A");
  if(k==="Digit2" || k==="KeyB") recordAnswer("B");
  if(k==="Digit3" || k==="KeyC") recordAnswer("C");
});

/* =========================================================
   End + CSV
   ========================================================= */
function downloadCSV(){
  const rows = [["ts","pid","qid","topic","option_order","selected","correct","is_correct","response_ms","score_after"]];
  for(const r of state.log){
    rows.push([r.ts,r.pid,r.qid,r.topic,r.option_order,r.selected,r.correct,r.is_correct,r.response_ms,r.score_after]);
  }
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="Secure_Inbox_Quiz_Log.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function endGame(){
  state.running = false;
  state.phase = "end";
  setActionsEnabled(false);
  readWrap.style.display = "none";
  setStatus("", false);

  const acc = state.attempted ? Math.round((state.correct/state.attempted)*100) : 0;
  document.getElementById("modalTitle").textContent = "Run Completed";
  document.getElementById("modalBody").innerHTML = `
    <p><b>Participant:</b> ${escapeHtml(PID)}</p>
    <p><b>Score:</b> ${state.score} &nbsp; | &nbsp; <b>Accuracy:</b> ${acc}% &nbsp; | &nbsp; <b>Attempted:</b> ${state.attempted}</p>
    <p class="muted">Download CSV for analysis.</p>
    <div class="row" style="justify-content:flex-start; margin-top:10px; gap:10px;">
      <button class="btn" id="dlBtn">Download CSV</button>
    </div>
  `;
  overlay.style.display="flex";
  setTimeout(()=> document.getElementById("dlBtn").onclick = downloadCSV, 0);
}

/* =========================================================
   Boot / controls
   ========================================================= */
function boot(){
  state.running = false;
  state.phase = "menu";
  state.score = 0;
  state.correct = 0;
  state.attempted = 0;
  state.qIndex = 0;
  state.log = [];

  state.questions = prepareQuestionsBalanced();
  qtotalEl.textContent = String(state.questions.length);

  topicBadge.textContent = "Ready";
  qTextEl.textContent = "Press Start to begin.";
  choicesEl.innerHTML = "";
  popupEl.style.display="none";
  readWrap.style.display="none";
  mailCard.style.display="none";
  setActionsEnabled(false);
  setChip("warn","Idle");
  setStatus("", false);

  updateHUD();
}

function startGame(){
  overlay.style.display = "none";
  state.running = true;
  setStatus("Starting…", true);
  setTimeout(()=> startQuestion(), 350);
}

document.getElementById("restartBtn").onclick = ()=> { overlay.style.display="none"; boot(); };
document.getElementById("startBtn").onclick = ()=> { if(!state.running) startGame(); };

boot();
</script>
</body>
</html>
